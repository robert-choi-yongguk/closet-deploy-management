name: 2. í†µí•© ë°°í¬ PR ìˆ˜ë™ ìƒì„± (ì¤‘ì•™ ê´€ë¦¬)

on:
  workflow_dispatch:

jobs:
  find-repos-with-logs:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.set-matrix.outputs.repos }}

    steps:
      - name: í˜„ì¬ ë ˆí¬ì§€í† ë¦¬(ì´ë ¥ ê´€ë¦¬ìš©) ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: 'pending' ë””ë ‰í† ë¦¬ì—ì„œ ë¡œê·¸ íŒŒì¼ ìŠ¤ìº” ë° ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„±
        id: set-matrix
        run: |
          cd pending || { echo "pending ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."; echo "repos=[]" >> $GITHUB_OUTPUT; exit 0; }

          repos_json="[]"
          repo_list=()

          for owner_dir in */ ; do
              owner=${owner_dir%/}
              cd "$owner" || continue
              for repo_dir in */ ; do
                  repo=${repo_dir%/}
                  log_file="$repo/history.log"
                  if [ -f "$log_file" ] && [ -s "$log_file" ]; then
                      repo_list+=("{\"owner\":\"$owner\", \"repo\":\"$repo\"}")
                  fi
              done
              cd ..
          done

          if [ ${#repo_list[@]} -gt 0 ]; then
              repos_json=$(IFS=,; echo "[${repo_list[*]}]")
          fi

          echo "ë°œê²¬ëœ ë ˆí¬ì§€í† ë¦¬: $repos_json"
          echo "repos=$repos_json" >> $GITHUB_OUTPUT


  create-release-prs:
    needs: find-repos-with-logs
    if: needs.find-repos-with-logs.outputs.repos != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo_info: ${{ fromJson(needs.find-repos-with-logs.outputs.repos) }}
      fail-fast: false

    steps:
      - name: í˜„ì¬ ë ˆí¬ì§€í† ë¦¬(ì´ë ¥ ê´€ë¦¬ìš©) ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        id: generate_release_note
        run: |
          LOG_FILE="pending/${{ matrix.repo_info.owner }}/${{ matrix.repo_info.repo }}/history.log"
          
          RELEASE_NOTE_BODY="### ğŸš€ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸\n\n"
          while IFS=, read -r pr_number pr_author; do
            RELEASE_NOTE_BODY="${RELEASE_NOTE_BODY}- #${pr_number} by ${pr_author}\n"
          done < "$LOG_FILE"
          
          echo "note<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RELEASE_NOTE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ëŒ€ìƒ ë ˆí¬ì§€í† ë¦¬ì— ë°°í¬ PR ìƒì„±
        env:
          GH_TOKEN: ${{ secrets.GH_RELEASE_PR_PAT }}
          RELEASE_DATE: $(date +'%Y-%m-%d')
          REPO_FULL_NAME: ${{ matrix.repo_info.owner }}/${{ matrix.repo_info.repo }}
        run: |
          if ! git ls-remote --exit-code --heads "https://x-access-token:${GH_TOKEN}@github.com/${REPO_FULL_NAME}.git" release >/dev/null; then
            echo "::warning::'release' ë¸Œëœì¹˜ê°€ '${REPO_FULL_NAME}' ë ˆí¬ì§€í† ë¦¬ì— ì¡´ì¬í•˜ì§€ ì•Šì•„ PR ìƒì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          gh pr create \
            --repo $REPO_FULL_NAME \
            --base main \
            --head release \
            --title "ğŸš€ Production Release - $RELEASE_DATE" \
            --body "${{ steps.generate_release_note.outputs.note }}"
