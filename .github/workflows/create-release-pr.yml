name: í†µí•© ë°°í¬ PR ìˆ˜ë™ ìƒì„± (ì¤‘ì•™ ê´€ë¦¬)

on:
  workflow_dispatch:

jobs:
  find-repos-with-logs:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.set-matrix.outputs.repos }}

    steps:
      - name: í˜„ì¬ ë ˆí¬ì§€í† ë¦¬(ì´ë ¥ ê´€ë¦¬ìš©) ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pending ë””ë ‰í† ë¦¬ì—ì„œ ë¡œê·¸ íŒŒì¼ ìŠ¤ìº” ë° ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„±
        id: set-matrix
        run: |
          if [ ! -d "pending" ]; then
            echo "pending ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
            echo "repos=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          REPOS_JSON="["
          FIRST=true
          for dir in $(find pending -mindepth 2 -maxdepth 2 -type d); do
            if [[ -f "$dir/history.log" && -s "$dir/history.log" ]]; then
              if [ "$FIRST" = "false" ]; then
                REPOS_JSON="$REPOS_JSON,"
              fi
              owner=$(echo "$dir" | cut -d'/' -f2)
              repo=$(echo "$dir" | cut -d'/' -f3)
              REPOS_JSON="$REPOS_JSON{\"owner\":\"$owner\",\"repo\":\"$repo\"}"
              FIRST=false
            fi
          done
          REPOS_JSON="$REPOS_JSON]"

          if [ "$REPOS_JSON" == "[]" ]; then
            echo "ë¦´ë¦¬ì¦ˆí•  ë‚´ìš©ì´ ìˆëŠ” ë¡œê·¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "repos=[]" >> $GITHUB_OUTPUT
          else
            echo "ë°œê²¬ëœ ë ˆí¬ì§€í† ë¦¬: $REPOS_JSON"
            echo "repos=$REPOS_JSON" >> $GITHUB_OUTPUT
          fi


  create-release-prs:
    needs: find-repos-with-logs
    if: needs.find-repos-with-logs.outputs.repos != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo_info: ${{ fromJson(needs.find-repos-with-logs.outputs.repos) }}
      fail-fast: false

    steps:
      - name: í˜„ì¬ ë ˆí¬ì§€í† ë¦¬(ì´ë ¥ ê´€ë¦¬ìš©) ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        id: generate_release_note
        run: |
          LOG_FILE="pending/${{ matrix.repo_info.owner }}/${{ matrix.repo_info.repo }}/history.log"
          
          RELEASE_NOTE_BODY="### ğŸš€ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸\n\n"
          while IFS=, read -r pr_number pr_author; do
            RELEASE_NOTE_BODY="${RELEASE_NOTE_BODY}- #${pr_number} by ${pr_author}\n"
          done < "$LOG_FILE"
          
          echo "note<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RELEASE_NOTE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ëŒ€ìƒ ë ˆí¬ì§€í† ë¦¬ì— ë°°í¬ PR ìƒì„±
        env:
          GH_TOKEN: ${{ secrets.GH_RELEASE_PR_PAT }}
          REPO_FULL_NAME: ${{ matrix.repo_info.owner }}/${{ matrix.repo_info.repo }}
        run: |
          RELEASE_DATE=$(date +'%Y-%m-%d')
          PR_TITLE="$RELEASE_DATE Release"

          if ! git ls-remote --exit-code --heads "https://x-access-token:${GH_TOKEN}@github.com/${REPO_FULL_NAME}.git" release >/dev/null; then
            echo "::warning::'release' ë¸Œëœì¹˜ê°€ '${REPO_FULL_NAME}' ë ˆí¬ì§€í† ë¦¬ì— ì¡´ì¬í•˜ì§€ ì•Šì•„ PR ìƒì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          gh pr create \
            --repo $REPO_FULL_NAME \
            --base main \
            --head release \
            --title "$PR_TITLE" \
            --body "${{ steps.generate_release_note.outputs.note }}" \
            --label "Deployment"
